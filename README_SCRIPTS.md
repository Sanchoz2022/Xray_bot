# Автоматические скрипты настройки и диагностики Xray Bot

## Обзор скриптов

### 1. `auto_setup.sh` - Полная автоматическая настройка сервера
**Назначение:** Полностью автоматическая установка и настройка Xray сервера с нуля.

**Что делает:**
- Устанавливает все зависимости (Xray, Python, системные пакеты)
- Генерирует новые Reality ключи
- Создает оптимизированную конфигурацию Xray
- Настраивает systemd сервис
- Обновляет .env файл с правильными ключами
- Настраивает права доступа
- Запускает и проверяет сервисы

**Использование:**
```bash
sudo ./auto_setup.sh
```

### 2. `full_diagnostic.sh` - Полная автоматическая диагностика
**Назначение:** Автоматическая диагностика и исправление всех проблем.

**Что делает:**
- Синхронизирует время системы
- Настраивает firewall (UFW)
- Исправляет DNS настройки
- Проверяет подключение к Google
- Генерирует новые Reality ключи
- Создает оптимизированную конфигурацию
- Синхронизирует .env файл
- Настраивает права доступа
- Запускает сервисы
- Проверяет порты и соединения
- Тестирует Reality подключение
- Создает отчет диагностики

**Использование:**
```bash
sudo ./full_diagnostic.sh
```

### 3. `diagnostic.sh` - Интерактивная диагностика (существующий)
**Назначение:** Интерактивное меню для выборочной диагностики и исправления.

**Функции:**
- Меню с выбором конкретных проверок
- Детальная диагностика каждого компонента
- Регенерация конфигурации с новыми ключами
- Просмотр логов и системной информации

**Использование:**
```bash
sudo ./diagnostic.sh
```

### 4. `fix_reality_keys.sh` - Исправление Reality ключей
**Назначение:** Генерация и синхронизация Reality ключей между сервером и ботом.

**Использование:**
```bash
./fix_reality_keys.sh
```

### 5. `get_public_key.py` - Генерация публичного ключа
**Назначение:** Python скрипт для получения публичного ключа из приватного.

**Использование:**
```bash
python3 get_public_key.py
```

## Рекомендуемый порядок использования

### Для новой установки:
1. `sudo ./auto_setup.sh` - полная автоматическая настройка
2. Обновить BOT_TOKEN и ADMIN_IDS в .env файле
3. Запустить бота: `python3 bot.py`

### Для диагностики проблем:
1. `sudo ./full_diagnostic.sh` - автоматическая диагностика и исправление
2. Если нужна детальная диагностика: `sudo ./diagnostic.sh`

### Для исправления только ключей Reality:
1. `./fix_reality_keys.sh` или `python3 get_public_key.py`

## Особенности скриптов

### Автоматические исправления:
- **Время:** Автоматическая синхронизация через chrony
- **Firewall:** Настройка UFW с необходимыми портами
- **DNS:** Настройка надежных DNS серверов (8.8.8.8, 1.1.1.1)
- **Reality ключи:** Генерация и синхронизация между сервером и ботом
- **Права доступа:** Настройка пользователя nobody:nogroup
- **Systemd:** Создание и настройка сервиса с автозапуском

### Проверки и тесты:
- **Порты:** 443 (VLESS), 50051 (gRPC API)
- **Сервисы:** Xray, xray-bot
- **Конфигурация:** Валидация JSON и Xray config
- **Сеть:** Подключение к Google, DNS разрешение
- **Reality:** Тест маскировки под Google сертификат

### Логирование и отчеты:
- Цветной вывод с уровнями логирования
- Автоматическое создание отчетов диагностики
- Резервные копии конфигурационных файлов
- Детальные логи всех операций

## Файлы конфигурации

### Основные файлы:
- `/usr/local/etc/xray/config.json` - конфигурация Xray
- `.env` - настройки бота
- `/etc/systemd/system/xray.service` - systemd сервис
- `/var/log/xray/` - логи Xray

### Резервные копии:
Все скрипты автоматически создают резервные копии перед изменениями:
- `.env.backup.TIMESTAMP`
- `config.json.backup.TIMESTAMP`

## Устранение проблем

### Если скрипты не запускаются:
```bash
chmod +x *.sh
chmod +x *.py
```

### Если нет прав root:
```bash
sudo ./script_name.sh
```

### Если проблемы с Reality ключами:
1. Запустите `sudo ./full_diagnostic.sh`
2. Или используйте `./fix_reality_keys.sh`

### Если порты не слушаются:
1. Проверьте firewall: `sudo ufw status`
2. Перезапустите сервис: `sudo systemctl restart xray`
3. Запустите диагностику: `sudo ./full_diagnostic.sh`

## Поддерживаемые системы
- Ubuntu 18.04+
- Debian 9+
- CentOS 7+ (с адаптацией команд)

Все скрипты протестированы и оптимизированы для максимальной совместимости и надежности.
